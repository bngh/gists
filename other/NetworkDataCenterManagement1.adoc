= TeamWork
:author: bngh

This interactive Neo4j tutorial covers a scenario in Network and Data Center Management for ACME. ACME is a fictional company with a large network infrastructure that includes a CRM application, ERP application, and a Data Warehousing solution. ACME has a series of public facing websites that they need to be up and running in order to conduct their business and support their customers.

'''

*Table of Contents*

* *Data Model*
** 
* *Consultas*
** *Elementales*
***
***
** *Intermedias*
***
*** 
** *Avanzadas*
***
***

=== ACME's Network Dependency Graph

image::http://raw.github.com/neo4j-contrib/gists/master/other/images/datacenter-management-1.PNG[Network Dependency Graph]

=== Database Setup

Below you will find the full Cypher script for creating ACME's Network Dependency Graph in Neo4j. This simple script is the full setup of the data set that we will later perform analysis on.

//setup
[source,cypher]
----
// Create Database

CREATE (b1:Band { name : 'Metallica',formed:1981,country:'USA' })
CREATE (b2:Band { name : 'Depeche Mode',formed:1980,country:'UK' })
CREATE (b3:Band { name : 'Ozzy Osbourne',formed:1979,country:'UK' })
CREATE (b4:Band { name : 'Dio',formed:1982,country:'USA' })
CREATE (b5:Band { name : 'Black Sabbath',formed:1968,country:'UK' })

CREATE (mk1:Musician { name : 'Ozzy Osbourne',born:1948,country:'UK'})
CREATE (mk2:Musician { name : 'Tony Iommi',born:1948,country:'UK'})
CREATE (mk3:Musician { name : 'Ian Gillan',born:1945,country:'UK'})
CREATE (mk4:Musician { name : 'Randy Rhoads',born:1956,country:'UK'})

CREATE (m1b1:Musician { name : 'James Hetfield',born:1963,country:'USA' })
CREATE (m2b1:Musician { name : 'Kirk Hammett',born:1962,country:'USA' })
CREATE (m3b1:Musician { name : 'Lars Ulrich',born:1963,country:'Denmark' })
CREATE (m4b1:Musician { name : 'Robert Trujillo',born:1964,country:'USA' })

CREATE (mn1:Musician { name : 'Ronnie James Dio',born:1942, country:'USA'})
CREATE (mn2:Musician { name : 'Craig Goldy',born:1961,country:'USA'})
CREATE (mn3:Musician { name : 'Rudy Sarzo',born:1950,country:'Cuba'})
CREATE (mn4:Musician { name : 'Simon Wright',born:1963,country:'USA'})
CREATE (mn5:Musician { name : 'Scott Warren',born:1962,country:'USA'})

CREATE (m2b2:Musician { name : 'Andrew Fletcher',born:1961,country:'UK' })
CREATE (m3b2:Musician { name : 'David Gahan',born:1962,country:'UK' })
CREATE (m4b2:Musician { name : 'Martin Gore',born:1961,country:'UK' })

CREATE (mgg1:Genre { name : 'Thrash Metal'})
CREATE (mgg2:Genre { name : 'Electronic'})
CREATE (mgg3:Genre { name : 'Industrial'})
CREATE (mgg4:Genre { name : 'New Wave'})
CREATE (mgg5:Genre { name : 'Synthpop'})
CREATE (mgg6:Genre { name : 'Heavy Metal'})
CREATE (mgg7:Genre { name : 'Doom Metal'})
CREATE (mgg8:Genre { name : 'Hard Rock'})
CREATE (mgg9:Genre { name : 'Rap'})

CREATE (m4b21:User { name : 'David',born:1993,country:'Madagascar' })
CREATE (m4b22:User { name : 'Alvaro',born:1994,country:'Spain' })
CREATE (m4b23:User { name : 'Mario',born:1990,country:'Spain' })
CREATE (m4b24:User { name : 'Ted',born:1972,country:'Norway' })
CREATE (m4b25:User { name : 'Nika',born:1990,country:'Slovenia' })

CREATE (mk1)-[r:Plays { instrument: 'Voice' }]->(b5)
CREATE (mk1)-[r0:Plays { instrument: 'Voice' }]->(b3)
CREATE (mk2)-[r1:Plays { instrument: 'Guitar' }]->(b5)
CREATE (mk3)-[r2:Plays { instrument: 'Voice' }]->(b5)
CREATE (mk4)-[r3:Plays { instrument: 'Guitar' }]->(b3)
CREATE (mn1)-[r4:Plays { instrument: 'Voice' }]->(b5)
CREATE (mn1)-[r5:Plays { instrument: 'Voice' }]->(b4)
CREATE (mn2)-[r6:Plays { instrument: 'Guitar' }]->(b4)
CREATE (mn3)-[r7:Plays { instrument: 'Bass' }]->(b4)
CREATE (mn4)-[r8:Plays { instrument: 'Drums' }]->(b4)
CREATE (mn5)-[r9:Plays { instrument: 'Keyboards' }]->(b4)

CREATE (m1b1)-[r10:Plays { instrument: 'Voice' }]->(b1)
CREATE (m1b1)-[r11:Plays { instrument: 'Guitar' }]->(b1)
CREATE (m2b1)-[r12:Plays { instrument: 'Guitar' }]->(b1)
CREATE (m3b1)-[r13:Plays { instrument: 'Drums' }]->(b1)
CREATE (m4b1)-[r14:Plays { instrument: 'Bass' }]->(b1)

CREATE (m2b2)-[r15:Plays { instrument: 'Keyboards' }]->(b2)
CREATE (m3b2)-[r16:Plays { instrument: 'Voice' }]->(b2)
CREATE (m4b2)-[r17:Plays { instrument: 'Guitars' }]->(b2)
CREATE (m4b2)-[r18:Plays { instrument: 'Keyboards' }]->(b2)

CREATE (b1)-[r19:Belongs]->(mgg1)

CREATE (b2)-[r20:Belongs]->(mgg2)
CREATE (b2)-[r21:Belongs]->(mgg3)
CREATE (b2)-[r22:Belongs]->(mgg4)
CREATE (b2)-[r23:Belongs]->(mgg5)

CREATE (b3)-[r24:Belongs]->(mgg6)
CREATE (b3)-[r25:Belongs]->(mgg8)

CREATE (b4)-[r26:Belongs]->(mgg6)

CREATE (b5)-[r27:Belongs]->(mgg6)
CREATE (b5)-[r28:Belongs]->(mgg7)

CREATE (m4b21)-[rt2:FriendOf]->(m4b25)
CREATE (m4b23)-[rt3:FriendOf]->(m4b25)
CREATE (m4b22)-[rt4:FriendOf]->(m4b25)
CREATE (m4b24)-[rt5:FriendOf]->(m4b22)
CREATE (m4b24)-[rt6:FriendOf]->(m4b23)

CREATE (m4b21)-[rt7:Listen]->(b1)
CREATE (m4b21)-[rt8:Listen]->(b2)
CREATE (m4b21)-[rt9:Listen]->(b3)
CREATE (m4b21)-[rt10:Listen]->(b4)

RETURN *

----

'''

=== Interactive Graph Visualization
//graph

'''

=== ACME's Network Inventory

The query below generates a data table that gives a quick overview of ACME's network infrastructure.

[source,cypher]
----
MATCH 	(n) 
RETURN 	labels(n)[0] as type,
		count(*) as count, 
		collect(n.host) as names
----

//table

'''

=== Find direct dependencies of all public websites

The query below queries the data model to find all business web applications that are on the public facing internet for ACME.

[source,cypher]
----
MATCH 		(website)-[:DEPENDS_ON]->(downstream)
WHERE		website.system = "INTERNET"
RETURN 		website.host as Host, 
			collect(downstream.host) as Dependencies
ORDER BY 	Host
----

//table

'''

=== Find direct dependencies of all internal websites

The query below queries the data model to find all business websites that are on the private intranet for ACME.

[source,cypher]
----
MATCH 		(website)-[:DEPENDS_ON]->(downstream)
WHERE		website.system = "INTRANET"
RETURN 		website.host as Host, 
			collect(downstream.host) as Dependencies
ORDER BY 	Host
----

//table

'''

=== Find the most depended-upon component

The query below finds the most heavily relied upon component within ACME's network infrastructure. As expected, the most depended upon component is the SAN (Storage Area Network).

[source,cypher]
----
MATCH 		(n)<-[:DEPENDS_ON*]-(dependent)
RETURN 		n.host as Host, 
			count(DISTINCT dependent) AS Dependents
ORDER BY 	Dependents DESC
LIMIT 		1
----

//table

'''

=== Find dependency chain for business critical components:  CRM

The query below finds the path of dependent components from left to right for ACME's CRM application. If ACME's CRM (Customer Relationship Management) application goes down it will cause significant impacts to its business. If any one of the components to the right of the CRM hostname fails, the CRM application will fail.

[source,cypher]
----
MATCH 		(dependency)<-[:DEPENDS_ON*]-(dependent)
WITH 		dependency, count(DISTINCT dependent) AS Dependents
ORDER BY 	Dependents DESC
LIMIT		1
WITH		dependency
MATCH 		p=(resource)-[:DEPENDS_ON*]->(dependency)
WHERE		resource.system = "CRM"
RETURN		"[" + head(nodes(p)).host + "]" + 
			reduce(s = "", n in tail(nodes(p)) | s + " -> " + "[" + n.host + "]") as Chain
----

//table

'''

=== Find dependency chain for business critical components:  ERP

The query below finds the path of dependent components from left to right for ACME's ERP (Enterprise Resource Planning) application. The ERP application represents an array of business resources dedicated to supporting ongoing business activities at ACME, including finance and supply chain management. If ACME's ERP application goes down it will cause significant impacts to its business. If any one of the components to the right of the ERP hostname fails, then the ERP application will fail. This failure will cause revenue impacts since ACME's business relies on this system to conduct business.

[source,cypher]
----
MATCH 		(dependency)<-[:DEPENDS_ON*]-(dependent)
WITH 		dependency, count(DISTINCT dependent) AS Dependents
ORDER BY 	Dependents DESC
LIMIT		1
WITH		dependency
MATCH 		p=(resource)-[:DEPENDS_ON*]->(dependency)
WHERE		resource.system = "ERP"
RETURN		"[" + head(nodes(p)).host + "]" + 
			reduce(s = "", n in tail(nodes(p)) | s + " -> " + "[" + n.host + "]") as Chain
----

//table

'''

=== Find dependency chain for business critical components: Data Warehouse

The query below finds the path of dependent components from left to right for ACME's DW (Data Warehouse) application. The DW application represents an array of business intelligence resources dedicated to supporting time-sensitive analytical processes at ACME. If ACME's DW application goes down it will cause significant impacts to the business operations at ACME on the technical side. If any one of the components to the right of the DW hostname fails, then the DW application will fail. This failure will cause public facing websites like the eCommerce application to not reflect the latest available data from ACME's ERP application.

[source,cypher]
----
MATCH 		(dependency)<-[:DEPENDS_ON*]-(dependent)
WITH 		dependency, count(DISTINCT dependent) AS Dependents
ORDER BY 	Dependents DESC
LIMIT		1
WITH		dependency
MATCH 		p=(resource)-[:DEPENDS_ON*]->(dependency)
WHERE		resource.system = "DW"
RETURN		"[" + head(nodes(p)).host + "]" + 
			reduce(s = "", n in tail(nodes(p)) | s + " -> " + "[" + n.host + "]") as Chain
----

//table

=== Find the impact of the removal of a network component : Hardware Server

The query below finds the applications depending on ACME's HARDWARE-SERVER-3. In case a network administrator wants to plan an intervention on the server, he has to know what will be the applications impacted. This way he can warn the applications users.

[source,cypher]
----
MATCH (application:Application)-[:DEPENDS_ON*]->(server)
WHERE       server.host = "HARDWARE-SERVER-3"
RETURN  application.type as Type,
        application.host as Host
----

//table
